
<script src="/socket.io/socket.io.js"></script>
<script src="keymaster.js"></script>

<script>

var socket = io.connect();

String.prototype.format = function () {
  var i = 0, args = arguments;
  return this.replace(/{}/g, function () {
    return typeof args[i] != 'undefined' ? args[i++] : '';
  });
};

var keyev = function(key, event){

        /*
        generic code for key event with a key letter..
        */

        if (event.keyCode == key.charCodeAt(0)-32 ){
            curr_func(key)
            return true
        }else{ return false }

      } // end keyev

function change_diapo(diapo_index, diapo_max, event, socket){

      /*
      Change diapo with arrow left or right
      */

      if (event.keyCode == 39){                                   // Increment
            if ((diapo_index+1) < diapo_max){ diapo_index += 1 }
            location.replace("d{}".format(diapo_index))
            socket.emit('numdiap', diapo_index)
            }
      if (event.keyCode == 37){                                   // Decrement
            if ((diapo_index-1) > -1){ diapo_index += -1 }
            location.replace("d{}".format(diapo_index))
            socket.emit('numdiap', diapo_index)
            }

      return diapo_index
}


function set_page_num(diapo_index){

      /*
      Set the page number
      */

      if (diapo_index!=0){
            //var loc = location.href.split('/')[3]
            $('#content').append($('</p>').attr('id', 'num').text(diapo_index))
            $('#num').css({'position':'absolute','top':'820px','right':'260px', 'font-size':'20px'})

        }

}

//---------------

$('h1').css({'right':'5%'})
var diapo_index = null
socket.on('numdiap', function(text){
      diapo_index = parseInt(text)
      set_page_num(diapo_index)
     })  // index of current diap
var diapo_max = null
socket.on('maxdiap', function(text){ diapo_max = text })    // number max of diap

$( document ).keydown(function() {                              // pass to a new diapo
    diapo_index = change_diapo(diapo_index, diapo_max, event, socket)
});

key('ctrl+d', function(){                      // Add a new diapo
      socket.emit('make_new_diap', '')
      alert('adding a new diapo !!!!!');
      return false
  });

var show_memos = false;
key('ctrl+m', function(){                      // activate deactivate the memos
      show_memos = !show_memos
      if (show_memos){
        $('.memo').css({'background-color':'#ffe6e6'})
      }else{$('.memo').css({'background-color':'#ffffff'})}

  });

key('ctrl+a', function(){         // go to the global view of the slides..
      diapo_index = 0
      location.replace("all")
      socket.emit('numdiap', diapo_index)  // set diapo_index to 0 for avoiding bad page number..
  });

$('h2').css({'border':'3px solid blue', 'display':'inline-block', 'padding':' 7px 7px 7px 7px'})
$('li').css({'font-size':'160%', 'margin': '30px 100px', 'color':'#000000'})
$('li li').css({'font-size':'80%', 'margin': '15px 30px', 'color':'#000000'})
$('.effect2').css({'box-shadow':'0 0 0 0'})
$('.navbar-inner').hide()
$('#toc').hide()
$('#content').css({'margin-left':'200px',
                   'padding-bottom':'20px',
                   'padding-top':'50px',
                   'height' : '790px'
                   })
//$('li li').hide()         // hide the Mémos
$('.help').hide()         // hide the help
$('#gobottom').hide()     // hide go to bottom

function remove_patt_change_css(elem,txt,patt,dic_css){

      /*
      Remove the pattern and modiy the css
      patt : pattern
      dic_css : dictionary of the css parameters..
      */

      var new_txt = txt.split(patt)[1]
      elem.text(new_txt)
      elem.css(dic_css)

}

function p_match__inject_css(patt, dic_css){

      /*
      Generic match replace
      patt : pattern
      dic_css : dictionary of the css parameters..
      */

      $("p").each(function(){
           var txt = $(this).text()
           if (txt.match(patt)){

               remove_patt_change_css($(this),txt,patt,dic_css)
               var class_added = patt.toString().slice(3,-1)
               //alert("class_added " + class_added)
               $(this).attr('class',class_added) // adding Class
               if (txt.match(/\!eq/)){                                // if equation..
                  $(this).text('$$' + $(this).text() + '$$')
               }
           }
       })
}

function find_target_memo(match_txt, num_memo){

      /*
      Target memos
      */

      var memo_short = match_txt.slice(1,-1) + num_memo // .slice(1,-1)
      var newreg = '\\$' + memo_short
      $('p').each(function(){
          var regdoll = new RegExp( newreg );
          if ( $(this).text().match(regdoll) ){
               $(this).next().attr('id', 'targ_memo' + num_memo)
               $(this).next().hide()     // hide the list after
               $(this).hide()         // hide the tag $memo
          }

      })

}

function tag_for_memo(elem,txt,reg){

      /*
      Tag the sentence and the target..
      */

      var match_txt = txt.match(reg)[0]
      var num_memo = match_txt.split('!memo')[1]
      elem.html(txt.split('!memo')[0])    // remove the pattern at the end..
      elem.attr('memo', num_memo)  // add the memo attribute..
      elem.addClass('memo')         // add the class memo
      find_target_memo(match_txt, num_memo)  // tag the target

}

function p_match_memos(elem){

      /*
      Handle the memos
      */

      var reg = /\!memo\d+/
      var num_memo = {}
      elem.each(function(){
           var txt = $(this).html()
           if (txt.match(reg)){
                tag_for_memo($(this),txt,reg)
           }
       })
}

function make_head(){

      /*
      header
      syntax : !head blablabla..
      */

      var dichead = {'position':'absolute','top':'80px',
                     'font-size':'120%', 'right':'250px'}
      p_match__inject_css(/\!head/, dichead)
      $('#content').append($('</p>').attr('id','footlim'))
      $('#footlim').html('<hr>')
      $('#footlim').css({'position':'absolute','top':'780px'})

}

function make_foot(){

      /*
      footer
      syntax : !foot blablabla..
      */

      var dicfoot = {'position':'absolute','top':'820px','font-size':'110%'}
      p_match__inject_css(/\!foot/, dicfoot)

      $('#content').append($('</p>').attr('id','footlim'))
      $('#footlim').html('<hr>')
      $('#footlim').css({'position':'absolute','top':'780px'})

}

function make_eq(){

      /*
      Equation
      syntax : !eq e^{i\pi}=-1
      */

      var diceq= {'position':'relative','font-size':'150%',
                  'text-align':' center '}
      p_match__inject_css(/\!eq/, diceq)

}

function make_title(){

      /*
      Place the title
      */

      $('h1').hide()
      $('li').hide()
      var dictit= {'position':'relative','font-size':'300%',
                  'text-align':'center', 'top':'100px',
                  'background-color':'orange', 'color':'white'}
      p_match__inject_css(/\!title/, dictit)

}

function make_author(){

      /*
      Place the author
      */

      var dicauth= {'position':'relative','font-size':'250%',
                  'text-align':'center', 'top':'250px',
                   'margin': 'auto'}
      p_match__inject_css(/\!author/, dicauth)

}

function make_date(){

      /*
      place the date
      */

      var dicdate= {'position':'relative','font-size':'200%',
                  'text-align':'center', 'top':'300px'}
      p_match__inject_css(/\!date/, dicdate)

}

make_head()  //-----------------------------  Header
make_foot()  //-----------------------------  Footer
make_eq()    //-----------------------------  Equation

$("p").each(function(){
     var txt = $(this).text()
     if (txt.match(/\!title/)){

       make_title()    //-----------------------------  Title
       make_author()    //-----------------------------  Author
       make_date()    //-----------------------------  Date

     }
  })

  $('.title').attr('align', 'center')
  $('.title').css({'line-height':'150%'})
  $('.author').wrap( "<div style='text-align:center;'></div>" )
  $('.date').attr('align', 'center')

//-----------------------------  Mémos

p_match_memos($("p"))
p_match_memos($("li"))

$('.memo').click(function(){
    if (show_memos){
          var num_memo = $(this).attr('memo')       // index of the memo
          tag_infos.html('<h1> Mémo ' + num_memo + ' </h1>')
          var targ_memo = '#targ_memo' + num_memo
          var clone = $(targ_memo).clone()
          clone.show()
          var diccss = {'font-size':'11px', 'margin':'10px 10px'}
          clone.css(diccss)
          tag_infos.append(clone)
          tag_infos.toggle()
    }

})

var tag_infos = $('<div>').attr('id','infos')
tag_infos.css({'position':'absolute',
              'top': '50px', 'left':'10px',
              'padding-left': '10px',
              'padding-right': '10px',
              'padding-top' : '50px',
              'width': '600px','height': '400px',
              'font-size' : '16px',
              'background-color':'white',
              'box-shadow': '8px 8px 12px #aaa',
              'opacity':'1',
              'z-index': '100'
            })

tag_infos.draggable()
$('#content').append(tag_infos.hide())
tag_infos.click(function(){
    $(this).toggle()
})


//-----------------------------

</script>
