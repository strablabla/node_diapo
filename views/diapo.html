
<script src="/socket.io/socket.io.js"></script>

<script>

var socket = io.connect();

var stp=0;

{% include '../lib/string_format.js' %}

console.log('===== DIAPO.HTML SCRIPT STARTING =====');

var keymap = {
        backspace: 8, tab: 9, clear: 12,
        enter: 13, 'return': 13,
        esc: 27, escape: 27, space: 32,
        left: 37, up: 38,
        right: 39, down: 40,
        del: 46, 'delete': 46,
        home: 36, end: 35,
        pageup: 33, pagedown: 34,
        ',': 188, '.': 190, '/': 191,
        '`': 192, '-': 189, '=': 187,
        ';': 186, '\'': 222,
        '[': 219, ']': 221, '\\': 220
  }

var keyev = function(key, event){

        /*
        generic code for key event with a key letter..
        */

        if (event.keyCode == key.charCodeAt(0)-32 ){
            curr_func(key)
            return true
        }else{ return false }

      } // end keyev


//------------------------

color_bar = "{{color_bar}}" //'violet'

// ============================================
// NAVIGATION SYSTEM - Included from navigation/navigation.js
// ============================================

{% include 'navigation/navigation.js' %}

//------------------ edit in  markdown

key('alt+t', function () {         // pass to text..
    window.location.href = 'text';                    // flip from html to textarea
});



// ============================================
// GLOBAL VIEW AND MINIATURES - Included from global_view/global_view.js
// ============================================

{% include 'global_view/global_view.js' %}


//------------------ new diapo

key('ctrl+p', function () {                      // Add a new diapo
    socket.emit('make_new_diap', '')
    alert('adding a new diapo !!!!!');
    return false
});

//------------------ delete the slide

key('alt+ctrl+x', function(){
    pos_before = diapo_index-1   //
    //alert('delete')
    window.location.href = 'd' + pos_before;
    socket.emit('delete', diapo_index)
    });

//----------------------- general configuration

$('li').css({'font-size':'160%', 'margin': '30px 100px', 'color':'#000000', 'margin-left':'200px'})
$('li li').css({'font-size':'80%', 'margin': '15px 30px', 'color':'#000000'})
$('h1').css({'margin-left':'100px'})
$('h2').css({'margin-left':'100px'})
$('p').css({'margin-left':'100px'})
$('.effect2').css({'box-shadow':'0 0 0 0'})
$('.navbar-inner').hide()
$('#toc').hide()
$('#content').css({'margin-left':'0px',
                   'margin-right':'0px',
                   'padding-bottom':'0px',
                   'padding-top':'0px',
                   'padding-left':'100px',
                   'height' : '100vh',
                   'min-height': '790px'
                   })
$('body').css({'margin': '0', 'padding': '0', 'overflow': 'hidden'})
$('html').css({'overflow': 'hidden'})
$('.container').css({
    'width': '100%',
    'max-width': '100%',
    'margin': '0',
    'padding': '0'
})
//$('li li').hide()         // hide the Mémos
$('.help').hide()         // hide the help
$('#gobottom').hide()     // hide go to bottom

function match__inject_stop(elem, patt){

      /*
      Inject class stop
      */

      elem.each(function(){
           var htm = $(this).html()
           if (htm.match(patt)){
               pattern = htm.match(patt)
               var class_added = pattern.slice(1,-1)
               $(this).attr('class', 'stop')                  // adding Class
           }
       })
}

// ============================================
// PROGRESSIVE VISUALIZATION - Included from step_by_step_visu/step_by_step_visu.js
// ============================================

{% include 'step_by_step_visu/step_by_step_visu.js' %}

function remove_patt_change_css(elem,txt,patt,dict_css){

      /*
      Remove the pattern and modify the css
      patt : pattern
      dict_css : dictionary of the css parameters..
      */

      var new_txt = txt.replace(patt,'')
      elem.text(new_txt)
      elem.css(dict_css)

}

function frame_col(){

      /*
      Frame with color around tag element
      eg: !fb  for blue frame ..
      */

      var dic_col = {'b':'blue','r':'red','g':'green','o':'orange'}
      var tags = ['h1','h2','h3']
      var reg = /\!f\w/
      for (var i in tags){
            $(tags[i]).each(function(){
                var regmatch = $(this).text().match(reg)
                if (regmatch){
                      var col = dic_col[regmatch[0].slice(-1)] // find color..
                      var cssfb = {'border':'3px solid ' + col, 'display':'inline-block', 'padding':' 7px 7px 7px 7px'}
                      elem_match__inject_css($(this), reg, cssfb)
                }
            })
      }
}

frame_col() // frame with color around the tag..

function elem_match__inject_css(elem, patt, dict_css){

      /*
      Generic match replace
      patt : pattern
      dict_css : dictionary of the css parameters..
      */

      if (patt==/\!fb/){alert('patt is fb')}
      elem.each(function(){
           var txt = $(this).text()
           if (txt.match(patt)){
               remove_patt_change_css($(this),txt,patt,dict_css)
               var class_added = patt.toString().slice(3,-1)
               //alert("class_added " + class_added)
               $(this).attr('class',class_added) // adding Class
               if (txt.match(/\!eq/)){                                // if equation..
                  $(this).text('$$' + $(this).text() + '$$')
               }
           }
       })
}

function p_match__inject_css(patt, dict_css){

      /*
      Generic match replace
      patt : pattern
      dict_css : dictionary of the css parameters..
      */

      elem_match__inject_css($("p"), patt, dict_css)

}


//------------------------ hiding voice tag

$('p').each(function(){
    var regtagv = new RegExp( '!tagv' );
    if ( $(this).text().match(regtagv) ){
         $(this).hide()         
    }
})

//------------------------

function change_pos(elem){

      /*
      Change the position of the element
      */

      var reg1 = /\!pos\d+\/\d+/

      elem.each(function(){
           var txt = $(this).text()
           var htm = $(this).html()
           if (txt.match(reg1)){
                  regmatch = txt.match(reg1)
                  var coord = regmatch[0].split('!pos')[1].split('/')
                  var x = parseFloat(coord[0])
                  var y = parseFloat(coord[1])

                  // Check if this paragraph contains an image
                  var hasImage = $(this).find('img').length > 0

                  if (hasImage) {
                      // For images: disable pointer-events on paragraph, enable on image
                      $(this).css({'position':'absolute','left':x + 'px', 'top':y + 'px', 'z-index':'1', 'pointer-events':'none'})
                      $(this).html(htm.replace(regmatch,''))
                      $(this).find('img').css('pointer-events', 'auto')
                  } else {
                      // For equations or other content: enable pointer-events on the whole paragraph
                      $(this).css({'position':'absolute','left':x + 'px', 'top':y + 'px', 'z-index':'1', 'pointer-events':'auto'})
                      $(this).html(htm.replace(regmatch,''))
                  }

                  // Mark with a class for special drag handling
                  $(this).addClass('positioned-image')
           }
      });
}

change_pos($('p'))

// ============================================
// DECORATION FUNCTIONS - Included from decorate/decorate.js
// ============================================

{% include 'decorate/decorate.js' %}

//----------- equation

function make_eq(){

      /*
      Equation
      syntax : !eq e^{i\pi}=-1
      */

      // Don't set position in diceq - let change_pos() handle it for positioned equations
      var diceq= {'font-size':'150%', 'text-align':' center '}
      p_match__inject_css(/\!eq/, diceq)

      // Assign unique IDs to equations for drag positioning
      var eq_counter = 0
      $('p.eq').each(function(){
          if (!$(this).attr('id')) {
              $(this).attr('id', 'eq-' + eq_counter)
              eq_counter++
          }

          // If equation doesn't have absolute positioning (no !pos marker), set relative
          if ($(this).css('position') !== 'absolute') {
              $(this).css('position', 'relative')
          }
      })

}

// ============================================
// FIRST PAGE FUNCTIONS - Included from first_page/first_page.htm
// ============================================

{% include 'first_page/first_page.htm' %}

make_head()  //-----------------------------  Header
make_foot()  //-----------------------------  Footer
make_eq()    //-----------------------------  Equation

//-----------------------------  Full screen

// Fullscreen functionality removed - use F11 for native browser fullscreen

//-----------------------------  go to markdown by voice

socket.on('markdown', function(){

     /*
     trigger markdown view
     */

     //alert('go to markdown !!! ')
     window.location.href = 'text'   // flip from html to textarea

    })

//-----------------------------  Mémos
// Memo system moved to memos/memo.js

// Memo event handlers and UI moved to memos/memo.js

//-------------------- Simple mardown..

simple_md = function(text){               // mini markdown for the help
     var all_text = text.split('\n')
     var htm = $('<div/>')
     var ul = $('<ul/>').css({'padding-left':'150px'})
     for (i in all_text){
         var text_insert = all_text[i].trim().slice(1) // prepare text
         if (all_text[i].match(/^\s{4}\*/)){    // detect list first level
             ul.append($('<li/>').text(text_insert).css({"font-weight": "bold"}))
             } // end if
         if (all_text[i].match(/^\s{8}\*/)){  // detect list second level
                 var interm1 = $('<ul/>').append($('<li/>').text(text_insert))
                 ul.append(interm1)
                 } // end if
         if (all_text[i].match(/^\s{12}\*/)){  // detect list third level
                 var interm2 = $('<ul/>').append($('<li/>').text(text_insert))
                 interm1.append(interm2)
                 } // end if
         if (all_text[i].match(/\s*\#/)){ // detect #
             htm.append( $('<h1/>').html(text_insert + '<br>' + '<br>') )
             } // end if
     } // end for
     htm.append(ul);
     return htm.html()
 } // end function

 //------------------------------- Generic css for alerts

 alerts_css_dict = { 'position':'absolute',
   'top': '200px', 'left':'100px',
   'padding-left': '10px',
   'padding-right': '10px',
   'padding-top' : '50px',
   'width': '400px','height': '200px',
   'font-size' : '16px',
   'background-color':'grey',
   'box-shadow': '8px 8px 12px #aaa',
   'opacity':'1',
   'z-index': '100'
 }

//------------------------------- Generic css dict for infos

infos_css_dict = { 'position':'absolute',
  'top': '50px', 'left':'10px',
  'padding-left': '10px',
  'padding-right': '10px',
  'padding-top' : '50px',
  'width': '600px','height': '400px',
  'font-size' : '16px',
  'background-color':'white',
  'box-shadow': '8px 8px 12px #aaa',
  'opacity':'1',
  'z-index': '100'
}

//--------------------------------  Help keys

var help_keys = $('<div>').attr('id','help_keys')
help_keys.css(infos_css_dict)

help_keys.draggable()
$('#content').append(help_keys.hide())
help_keys.click(function(){
    $(this).toggle()
})

//--------------------- available keys

var keys = function(){/*

# Keys

* Keys ::
    * ctrl + a : view all the slides
    * alt + h : help
    * ctrl + i : save the position of the picture..
    * ctrl + m : show memos..
    * alt+m : miniatures
    * ctrl + p : create new slide
    * alt + s : show text sequentially
    * alt + t : show markdown
    * alt+ctrl+x : delete slide
    * > : slide + 1
    * < : slide - 1

*/}.toString().slice(14,-3)

$('#help_keys').html(simple_md(keys))

//--------------------- Show the help

key('alt+k', function(){         // Show the help, voice : "aide"
    $('#help_keys').toggle()
  });

//--------------------------------  Help voice commands

var help_voice_cmds = $('<div>').attr('id','help_voice_cmds')
help_voice_cmds.css(infos_css_dict)

help_voice_cmds.draggable()
$('#content').append(help_voice_cmds.hide())
help_voice_cmds.click(function(){
    $(this).toggle()
})

//------------------------ available voice commands

var voice_cmds = function(){/*

# Voice commands

* Voice ::
    * aide : help
    * nouvelle diapo : create new slide
    * toutes les diapos : view all the slides
    * memos : show memos..
    * diapo + num : go to diapo num ..

*/}.toString().slice(14,-3)

$('#help_voice_cmds').html(simple_md(voice_cmds))

//----------- voice commands

key('alt+v', function(){         // Show the help
    $('#help_voice_cmds').toggle()
  });


//---------------------------------

// Make both images (p figure) and equations (p.eq) draggable
$('p figure, p.eq').each(function(){
    var $element = $(this);
    var wasDragged = false;

    $element.draggable({
        start: function() {
            wasDragged = false;
        },
        drag: function() {
            wasDragged = true;
        },
        stop: function() {
            // Keep wasDragged true for a moment after stopping
            setTimeout(function() {
                wasDragged = false;
            }, 200);
        }
    });

    // Prevent click after dragging
    $element.on('click', function(e) {
        if (wasDragged) {
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
        }
    });

    $element.find('img').on('click', function(e) {
        if (wasDragged) {
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
        }
    });
})

// ============================================
// CONTEXT MENU - Included from context_menu/context_menu.js
// ============================================

{% include 'context_menu/context_menu.js' %}

//------------------------- fixing image's and equation's position

key('ctrl+s', function(e){

      /*
      Fixing image and equation position..
      */

      // Prevent browser's default save dialog
      e.preventDefault()

      var count = 0
      $('p figure, p.eq').each(function(){
          var pos = $(this).offset()
          var id = $(this).attr('id')
          if (id) {
              // For images, remove the -## suffix (slice 0,-3)
              // For equations, use the id as-is
              var cleanId = id.match(/\d{2}$/) ? id.slice(0,-3) : id
              socket.emit('pos_img', cleanId + '§§' + JSON.stringify(pos))
              count++
          }
      })

      // Show confirmation message
      if (count === 0) return  // Don't show message if nothing to save

      // Create and display temporary message div
      var $msgDiv = $('<div>')
          .text('Position saved')
          .css({
              'position': 'fixed',
              'top': '50%',
              'left': '50%',
              'transform': 'translate(-50%, -50%)',
              'background-color': '#4CAF50',
              'color': 'white',
              'padding': '20px 40px',
              'border-radius': '5px',
              'font-size': '18px',
              'z-index': '10000',
              'box-shadow': '0 4px 6px rgba(0,0,0,0.3)'
          })

      $('body').append($msgDiv)

      // Remove message after 1 second
      setTimeout(function() {
          $msgDiv.fadeOut(300, function() {
              $(this).remove()
          })
      }, 1000)

      // Update thumbnail for current slide
      socket.emit('update_thumbnail')

      return false  // Prevent any default browser behavior
})

//--------------------------------  Help syntax

var help_syntax = $('<div>').attr('id','help_syntax')
infos_css_dict.height = 700;
//infos_css_dict['padding-left'] = -50;
help_syntax.css(infos_css_dict)
help_syntax.draggable()
$('#content').append(help_syntax.hide())
help_syntax.click(function(){
    $(this).toggle()
})

//------------------------ available Syntax

var syntax = function(){/*

# syntax

* Syntax ::
    * diese : title
    * !head :  header
    * !foot : footer
    * blabla !fo, put blabla in orange frame
    * $memo0 : create a numbered memo..
    * !memo0 : at the end of a line, indicates where to apply the memo..
    * !stp : stop the slide undtil this sign..

*/}.toString().slice(14,-3)

$('#help_syntax').html(simple_md(syntax))

//-------  show syntax

socket.on('syntax', function(){
     /*
     toggle syntax
     */
     $('#help_syntax').toggle()
    })
key('alt+h', function(){         // show syntax
    $('#help_syntax').toggle()
})

//--------------------------------  Configuration

var config = $('<div>').attr('id','config')
config.css(infos_css_dict)

config.draggable()
$('#content').append(config.hide())
config.click(function(){
    $(this).toggle()
})

//------------------------ available voice commands

var config_content = function(){/*

# Configuration

* Config ::
    * blabla

*/}.toString().slice(14,-3)

$('#config').html(simple_md(config_content))

//-------  show config

socket.on('config', function(){

     /*
     toggle config
     */
     //alert("configuration !!!!!!!!!!!")
     $('#config').toggle()

    })

key('alt+c', function(){         // show config
    $('#config').toggle()
})

// ============================================
// PDF GENERATION - Included from create_pdf/create_pdf.js
// ============================================

{% include 'create_pdf/create_pdf.js' %}

// ============================================
// DRAG & DROP IMAGE UPLOAD - Included from drag_and_drop/dropzone.js
// ============================================

{% include 'drag_and_drop/dropzone.js' %}

// ============================================
// SCREEN DIMENSIONS DETECTION - Included from screen/screen_detection.js
// ============================================

{% include 'screen/screen_detection.js' %}

// ============================================
// MEMO SYSTEM - Included from memos/memo.js
// ============================================

{% include 'memos/memo.js' %}

</script>
