{% include 'begin.html' %}
{% include 'header.html' %}
{% include 'voice.html' %}

<style>
body, html {
    overflow-x: auto;
    overflow-y: auto;
}
</style>

<h1> Miniatures </h1>

<br><br><br><br>

{% for i in range(0, number_diapos) -%}

        <img id="thumb{{i}}" src="thumbnails/thumb_{{i}}.png" class="thumbnail" data-diapo="{{i}}" />
        <span class="name_diap" id="d{{i}}"> {{i}} </span>

{% endfor %}

<div id="bottom_spacer"></div>
<div id="right_spacer"></div>

<script>

var socket = io.connect();

// Override overflow settings from diapo.html to enable scrolling both horizontally and vertically
// Use a slight delay to ensure this runs after diapo.html's overflow:hidden
setTimeout(function() {
    $('body').css({'overflow-y': 'auto !important', 'overflow-x': 'auto !important'});
    $('html').css({'overflow-y': 'auto !important', 'overflow-x': 'auto !important'});
    // Also set via setAttribute to ensure it takes effect
    document.body.style.setProperty('overflow-y', 'auto', 'important');
    document.body.style.setProperty('overflow-x', 'auto', 'important');
    document.documentElement.style.setProperty('overflow-y', 'auto', 'important');
    document.documentElement.style.setProperty('overflow-x', 'auto', 'important');
}, 100);

// Thumbnail dimensions (from Puppeteer screenshot: 1200x800)
var thumbWidth = 240  // 20% of 1200
var thumbHeight = 160  // 20% of 800

var nbcol = {{nb_horiz_mosaic}}    // nb of columns in the mosaic
var nblines = Math.round({{number_diapos}}/nbcol)  // nb of lines in the mosaic
var modulo = {{number_diapos}}%nbcol
if ( modulo != 0 ){nblines += 1}

// Style all thumbnails
$('.thumbnail').css({
    'position': 'absolute',
    'width': thumbWidth + 'px',
    'height': thumbHeight + 'px',
    'cursor': 'pointer',
    'border': '2px solid #ccc',
    'box-shadow': '0 2px 5px rgba(0,0,0,0.2)'
})

function one_diap(currdiap,i,j){
      /*
      Position one thumbnail
      */
      var margin = 60
      var spacingX = thumbWidth + margin
      var spacingY = thumbHeight + 60

      // Calculate position - centered if window is wide enough, otherwise use fixed margin
      var mosaicWidth = nbcol * spacingX
      var startX = Math.max(50, (window.innerWidth - mosaicWidth) / 2)  // Min 50px from left

      var posx = startX + spacingX*j
      var posy = 150 + spacingY*i

      // Center the number above the thumbnail
      var posxd = posx + thumbWidth/2
      var posyd = posy - 30

      $('#thumb' + currdiap).css({'top' : posy, 'left' : posx})
      $('#d' + currdiap).css({
          'position': 'absolute',
          'top' : posyd,
          'left' : posxd,
          'font-size' : '11px',
          'text-align' : 'center',
          'transform': 'translateX(-50%)',
          'font-weight': 'bold'
      })
}

function make_the_mosaic(nblines,nbcol){
      /*
      Build the complete mosaic representation
      */
      for (var i=0; i < nblines; i++){
          for (var j=0; j < nbcol; j++){
               var currdiap = i*nbcol + j
               if (currdiap < {{number_diapos}}){
                    one_diap(currdiap,i,j)
              }
          }
      }
}

make_the_mosaic(nblines,nbcol)

// Add right spacer to create margin when scrolling to the right
var margin = 60
var spacingX = thumbWidth + margin
var mosaicWidth = nbcol * spacingX
var startX = Math.max(50, (window.innerWidth - mosaicWidth) / 2)
var rightEdge = startX + mosaicWidth - margin  // Right edge of last thumbnail (without the margin spacing)
$('#right_spacer').css({
    'position': 'absolute',
    'left': (rightEdge + 50) + 'px',  // 25px margin after last thumbnail
    'top': '0px',
    'height': '100vh',
    'width': '1px'
})

// Click on thumbnail to navigate to that slide
$('.thumbnail').click(function(){
      var diapoNum = parseInt($(this).attr('data-diapo'))
      var diapoId = 'd' + diapoNum
      socket.emit('numdiap', diapoNum)
      location.replace(diapoId)
})

// Click on number to navigate to that slide
$('.name_diap').click(function(){
      socket.emit('numdiap', parseInt($(this).attr('id').slice(1)))
      location.replace($(this).attr('id'))
})

// Handle window resize
function repositionMiniatures() {
    make_the_mosaic(nblines, nbcol)
}

window.addEventListener('resize', function() {
    setTimeout(repositionMiniatures, 100)
})

</script>


{% include 'diapo.html' %}
{% include 'math.html' %}
{% include 'scroll_socket.html' %}
{% include 'end.html' %}
